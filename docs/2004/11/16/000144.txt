1:"$Sreact.fragment"
2:I[8154,["177","static/chunks/app/layout-20cb8a2c4d1128a9.js"],"ThemeProvider"]
3:I[5244,[],""]
4:I[8725,["39","static/chunks/app/error-84b2fc390f5d90f5.js"],"default"]
5:I[3866,[],""]
7:I[6213,[],"OutletBoundary"]
a:I[6213,[],"ViewportBoundary"]
c:I[6213,[],"MetadataBoundary"]
e:I[4835,[],""]
:HC["/",""]
:HL["/_next/static/css/f0808d9e9dfe64ef.css","style"]
:HL["/_next/static/css/4e78de3af272c993.css","style"]
0:{"P":null,"b":"Dx92N5Tia2flUNx8nFMKW","p":"","c":["","2004","11","16","000144"],"i":false,"f":[[["",{"children":[["slug","2004/11/16/000144","c"],{"children":["__PAGE__",{}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/f0808d9e9dfe64ef.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/4e78de3af272c993.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"zh-CN","suppressHydrationWarning":true,"className":"__variable_faf15b __variable_4686ee __variable_130a78 antialiased","children":[["$","head",null,{"children":[["$","script",null,{"src":"/theme-switcher.js","defer":true}],["$","script",null,{"dangerouslySetInnerHTML":{"__html":"\n            (function() {\n              try {\n                const storedTheme = localStorage.getItem('theme-preference');\n                const theme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');\n                document.documentElement.classList.add(theme);\n              } catch (e) {}\n            })();\n          "}}]]}],["$","body",null,{"children":["$","$L2",null,{"attribute":"class","defaultTheme":"system","enableSystem":true,"disableTransitionOnChange":true,"storageKey":"theme-preference","children":["$","$L3",null,{"parallelRouterKey":"children","error":"$4","errorStyles":[],"errorScripts":[],"template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"min-h-screen flex items-center justify-center","children":["$","div",null,{"className":"text-center","children":[["$","h1",null,{"className":"text-4xl font-bold mb-4","children":"404 - Page Not Found"}],["$","p",null,{"className":"text-gray-600","children":"The page you're looking for doesn't exist."}]]}]}],"$undefined",[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]}]]}]]}],{"children":[["slug","2004/11/16/000144","c"],["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L6","$undefined",null,["$","$L7",null,{"children":["$L8","$L9",null]}]]}],{},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","NTwqkvT9OTKEEeFTzawiQ",{"children":[["$","$La",null,{"children":"$Lb"}],["$","meta",null,{"name":"next-size-adjust","content":""}]]}],["$","$Lc",null,{"children":"$Ld"}]]}],false]],"m":"$undefined","G":["$e","$undefined"],"s":false,"S":true}
f:I[4223,["48","static/chunks/app/%5B...slug%5D/page-44bd698ec973eb49.js"],"Header"]
10:T2086,

<p>　　今天在 <a href="http://www.verycd.com/">VeryCD</a> 服务器上设置了访问日志的轮巡、合并、分析。</p><h3>VeryCD 目前的网页服务器配置结构</h3><ul><li>1 台 <a href="http://www.mysql.com/">MySQL</a> 数据库 + NFS 文件服务器，无域名指向，定义为 host1.verycd.com；</li><li>2 台静态页 + 资源搜索服务器，域名为 www.verycd.com 及 lib.verycd.com，DNS 轮巡，定义为 host2.verycd.com 及 host3.verycd.com，host3 上还有 emule.org.cn；</li><li>2 台论坛服务器，域名为 bbs.verycd.com 及 blog.verycd.com，DNS 轮巡，定义为 host4.verycd.com 及 host5.verycd.com；</li><li>OS 均为 <a href="http://www.redhat.com/">RedHad Linux 9</a>，Web 服务器均为 <a href="http://httpd.apache.org/">Apache 2.0.49</a></li></ul><h4>构思</h4><p>　　上个月 VeryCD 使用的是<strong>章文嵩</strong>博士的 <a href="http://linuxvirtualserver.org/">Linux Virtual Server</a> 软件，该系统<!--StartFragment -->针对高可伸缩、高可用网络服务的需求，给出了基于IP层和基于内容请求分发的负载平衡调度解决方法，它通过前端一个负载调度器（Load Balancer）无缝地将网络请求调度到真实服务器上，从而使得服务器集群的结构对客户是隐藏的， <!--StartFragment -->客户访问集群系统提供的网络服务就像访问一台高性能、高可用的服务器一样。因此整个网站的访问统计的取样就显得很简单，只要在一台 Web 服务器上分析自己的日志就行了，其他服务器的请求就是它的一个线性分布，系数大致就是硬件的性能比。</p><p>　　而现在整个网站由多个 Web 服务器 DNS 轮巡构成，网站结构对于用户是透明的，因此不能使用简单的抽样分析方法，分析日志的过程就比单个服务器的情况复杂得多。于是希望构建一套系统，能实现自动综合分析多个 Web 服务器的日志，给出准确直观的网站访问状况报告，而不是某台服务器单个的访问状况报告。</p><p>　　注：千万不能<!--StartFragment -->将日志记录到同一个远程(NFS)文件里。如果使用远程文件系统记录日志，带来的麻烦远比你获得的方便多的多！</p>
<br /><br />
<h3>Apache 日志分割、轮巡</h3><p>　　使用 <a href="http://www.cronolog.org/">cronolog</a>，到<a href="http://cronolog.org/download/cronolog-1.6.2.tar.gz">官方网站上下载 1.6.2 版</a>，编译：</p><div class="code">#tar -xzf cronolog-1.6.2.tar.gz<br />#cd cronolog-1.6.2<br />#./configure<br />#make<br /></div>Copy 到 Apache 的 bin 目录：<div class="code">#cp src/cronolog /usr/local/apache2/bin/cronolog</div>然后编辑 Apache 的 httpd.conf：<div class="code">#vi /usr/local/apache2/conf/httpd.conf</div>这里我自定义了一个 LogFormat &quot;all&quot;：<div class="code">Format &quot;%v %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; all</div><p>就是在 Apache 默认的 combined 格式的最前面加了 %v 以区别不同的虚拟主机访问。如果该 Web 服务器没有设置虚拟主机的话，%v 出来的将是星号(*)。查了 Apache 手册后，没找到能反映 <a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html">HTTP/1.1</a> 协议中 Host 字段所对应的变量。为了能和其他日志格式兼容，我用了个笨办法——直接将该服务器所对应的域名写在里面，于是，没有设置虚拟主机的 Appache 的日志格式成了类似：</p><div class="code">Format &quot;bbs.verycd.com %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; all</div>修改 CustomLog，实现按天分割、按周轮巡：<div class="code">CustomLog &quot;|/usr/local/apache2/bin/cronolog /var/log/httpd/%w.log&quot; all</div><p>重起 Apache，OK。</p><p>　　随后要做的是每天定时将前一天的 Log 发送到日志分析服务器，并删除五天前的那份 Log：</p><div class="code">#crontab -u root -e</div>每天凌晨 0:10 Copy 前一天的日志到日志分析服务器，我这就是 NFS 的路径；1:40删除旧日志：<div class="code">10 0 * * * /bin/cp -f /var/log/httpd/`date -d yesterday +\%w`.log /var/hosts/com/verycd/host1.log<br />10 1 * * * /bin/rm -f /var/log/httpd/`date --date &quot;5 days ago&quot; +\%w`.log</div><p /><p>　　到此，Apache 分割、轮巡，定时发送、删除日志的工作就做好了。</p><h3>合并日志</h3><p>　　现在日志分析服务器上已经有全部完整的、按日期精确分割的 Log 文件了，如何定时将它们合并在一起送交分析软件呢？在日志分析服务器上：</p><div class="code">#crontab -u root -e</div>每天 1:30 将host2.log、host3.log、host4.log、host5.log 按照时间排序合并到 all.log：<div class="code">30 1 * * *    /bin/sort -m -t : -k 2,4 -o /var/hosts/com/verycd/all.log   /var/hosts/com/verycd/host2.log  /var/hosts/com/verycd/host3.log   /var/hosts/com/verycd/host4.log   /var/hosts/com/verycd/host5.log</div><p /><p>　　完成日志合并工作。</p><h3>分析日志</h3><p>　　由于以前只接触过 Windows 系列服务器，因此我已经习惯使用跨平台的 <a href="http://awstats.sourceforge.net/">AwStats</a> 分析日志，那还是继续使用吧。在官方网站上就有下载，有 tgz 包和 rpm 安装包，还有 For Win32 的 .exe 安装程序……安装我这就不多说了，只是需要 Perl &gt; 5.0。</p><p>　　使用也非常简便，只要按照他的设置修改几处地方即可，修改 awstats.model.conf：</p><ul><li>LogFile=&quot;/var/hosts/com/verycd/all.log&quot;</li><li>LogFormat= &quot;%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot&quot;</li><li>DirData=&quot;./data&quot; # 分析好的数据存放的路径，可以是系统的绝对路径，也可以是相对于 awstats.pl 的相对路径，需要手动建立，并赋予 0777 属性</li><li>其他参数默认即可，每个参数配置文件里都有详细解释，耐心的话一会儿就能都基本理解了。</li></ul><p>　　新建 awstats.lib.verycd.conf awstats.bbs.verycd.conf awstats.emule.org.cn.conf 等配置文件（awstats.自定义配置名称.conf），保存于 awstats.pl 相同目录下，内容大致如下：</p><div class="code">Include &quot;awstats.model.conf&quot; # 引入主配置文件，共享参数<br /># 各自配置<br />SiteDomain=&quot;lib.verycd.com&quot; # 主机名<br />HostAliases=&quot;www.verycd.com&quot; # 主机别名</div><p /><p>　　将 wwwroot 目录下所有文件复制到网站的某个目录，例如，/log。在 Apache 中开放 awstats.pl 所在目录的 ExecCGI 权限：</p><div class="code">AddHandler cgi-script .cgi .pl<br />&lt;Directory /var/hosts/com/verycd/lib/log&gt;<br />    Options +ExecCGI<br />&lt;/Directory&gt;</div><p>　　另外，如果访问是500错误的话，修改 awstats.pl 的权限试试看。</p><p>　　接下去是设置定时分析日志：</p><ol><li>新建一个脚本文件 uodate_sites_logs.sh，内容大致如下：<div class="code">/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=lib.verycd.com -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=blog.verycd.com -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=emule.org.cn -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=dl1.emule.org.cn -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=bbs.verycd.com -update=1<br /></div></li><li><div class="code">#crontab -u root -e</div></li><li>每天 3:30 执行这个脚本<div class="code">30 3 * * * /bin/sh /var/local/bin/crontab/update_sites_logs.sh</div></li></ol><h3>Demo</h3><p>　　VeryCD 的访问统计可见 <a href="http://www.verycd.com/log/">http://www.verycd.com/log/</a></p><h3>参考文档：</h3><p /><hr /><p /><ul><li><a href="http://www.chedong.com/tech/rotate_merge_log.html">http://www.chedong.com/tech/rotate_merge_log.html</a></li><li><a href="http://cronolog.org/">http://cronolog.org/</a></li><li><a href="http://awstats.sourceforge.net/">http://awstats.sourceforge.net/</a></li></ul>

6:["$","div",null,{"className":"min-h-screen","children":[["$","$Lf",null,{}],["$","main",null,{"className":"container max-w-3xl mx-auto pb-24","children":["$","article",null,{"className":"prose prose-lg px-4 md:px-8 dark:prose-invert max-w-none","children":[["$","h1",null,{"className":"text-2xl font-bold","children":"Apache日志轮巡/合并/分析"}],["$","time",null,{"className":"text-md text-muted-foreground","children":"November 16, 2004"}],["$","div",null,{"dangerouslySetInnerHTML":{"__html":"$10"},"className":"text-lg"}]]}]}]]}]
b:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
8:null
9:null
d:[["$","title","0",{"children":"Yunjie Dai"}],["$","meta","1",{"name":"description","content":"This is Yunjie Dai's Homepage and Blog."}],["$","link","2",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}]]
