<!DOCTYPE html><html lang="zh-CN" class="__variable_c4692a antialiased"><head><meta charSet="utf-8"/><link rel="preconnect" href="/" crossorigin=""/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/89fe303d45fc1d3c.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-fe83f22eebcef24a.js"/><script src="/_next/static/chunks/4bd1b696-07549356623625fd.js" async=""></script><script src="/_next/static/chunks/587-c2ee8971ddae4e86.js" async=""></script><script src="/_next/static/chunks/main-app-a30ecb3c5bf8d20f.js" async=""></script><script src="/_next/static/chunks/app/layout-18d5088c99c4b723.js" async=""></script><script src="/_next/static/chunks/app/error-819170ca5010743f.js" async=""></script><script async="" src="/theme-switcher.js"></script><script id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script><script src="/_next/static/chunks/app/%5B...slug%5D/page-fc406cbb95aa160c.js" async=""></script><meta name="next-size-adjust" content=""/><title>Apache日志轮巡/合并/分析 - xdanger&#x27;s Blog</title><meta name="description" content="Apache日志轮巡/合并/分析"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><script>
            (function() {
              try {
                // Store theme preference but don't apply it immediately
                const storedTheme = localStorage.getItem('theme-preference');
                const preferredTheme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

                // Set a data attribute instead of class to avoid hydration mismatch
                document.documentElement.dataset.theme = preferredTheme;

                // Apply the theme class after hydration
                window.addEventListener('DOMContentLoaded', () => {
                  setTimeout(() => {
                    document.documentElement.classList.add(preferredTheme);
                  }, 0);
                });
              } catch (e) {}
            })();
          </script><script>
            window.MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
              },
              svg: {
                fontCache: 'global',
                scale: 1.1  // 增大公式字体大小，默认为 1.0
              },
              startup: {
                ready: function() {
                  console.log('MathJax is ready');
                  MathJax.startup.defaultReady();
                }
              }
            };
          </script><script>
            // Simplified MathJax rendering handler
            window.renderMathJax = function() {
              if (typeof window.MathJax !== 'undefined' && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise()
                  .then(() => console.log('MathJax render complete'))
                  .catch(err => console.error('MathJax render error:', err));
              }
            };

            // Setup on page load
            window.addEventListener('load', function() {
              console.log('Page loaded, setting up MathJax');

              // Initial render with retry
              const checkAndRender = function() {
                if (typeof window.MathJax !== 'undefined' && window.MathJax.typesetPromise) {
                  console.log('MathJax loaded, rendering');
                  setTimeout(window.renderMathJax, 500);

                  // URL change detection
                  let lastUrl = window.location.href;
                  setInterval(() => {
                    if (lastUrl !== window.location.href) {
                      console.log('URL changed, re-rendering');
                      lastUrl = window.location.href;
                      setTimeout(window.renderMathJax, 500);
                    }
                  }, 500);

                  // Content change detection
                  if (typeof MutationObserver !== 'undefined') {
                    const observer = new MutationObserver(mutations => {
                      if (mutations.some(m => m.addedNodes.length > 0)) {
                        console.log('Content changed, re-rendering');
                        setTimeout(window.renderMathJax, 500);
                      }
                    });

                    observer.observe(document.body, {
                      childList: true,
                      subtree: true
                    });
                  }
                } else {
                  console.log('MathJax not loaded yet, retrying');
                  setTimeout(checkAndRender, 500);
                }
              };

              setTimeout(checkAndRender, 1000);
            });
          </script><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><script>((e,t,r,n,o,a,i,u)=>{let s=document.documentElement,l=["light","dark"];function c(t){var r;(Array.isArray(e)?e:[e]).forEach(e=>{let r="class"===e,n=r&&a?o.map(e=>a[e]||e):o;r?(s.classList.remove(...n),s.classList.add(t)):s.setAttribute(e,t)}),r=t,u&&l.includes(r)&&(s.style.colorScheme=r)}if(n)c(n);else try{let e=localStorage.getItem(t)||r,n=i&&"system"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;c(n)}catch(e){}})("class","theme-preference","system",null,["light","dark"],null,true,false)</script><div class="min-h-screen"><header class="py-6"><div class="container max-w-3xl mx-auto px-4 md:px-8 flex items-center justify-between"><a class="text-2xl font-bold tracking-tight" href="/">Yunjie Dai</a></div></header><main class="container max-w-3xl mx-auto pb-24"><article class="prose px-4 md:px-8 dark:prose-invert max-w-none"><h1>Apache日志轮巡/合并/分析</h1><time class="text-muted-foreground">November 16, 2004</time><div class="prose max-w-full"><div class="text-lg">

<p>　　今天在 <a href="http://www.verycd.com/">VeryCD</a> 服务器上设置了访问日志的轮巡、合并、分析。</p><h3>VeryCD 目前的网页服务器配置结构</h3><ul><li>1 台 <a href="http://www.mysql.com/">MySQL</a> 数据库 + NFS 文件服务器，无域名指向，定义为 host1.verycd.com；</li><li>2 台静态页 + 资源搜索服务器，域名为 www.verycd.com 及 lib.verycd.com，DNS 轮巡，定义为 host2.verycd.com 及 host3.verycd.com，host3 上还有 emule.org.cn；</li><li>2 台论坛服务器，域名为 bbs.verycd.com 及 blog.verycd.com，DNS 轮巡，定义为 host4.verycd.com 及 host5.verycd.com；</li><li>OS 均为 <a href="http://www.redhat.com/">RedHad Linux 9</a>，Web 服务器均为 <a href="http://httpd.apache.org/">Apache 2.0.49</a></li></ul><h4>构思</h4><p>　　上个月 VeryCD 使用的是<strong>章文嵩</strong>博士的 <a href="http://linuxvirtualserver.org/">Linux Virtual Server</a> 软件，该系统<!--StartFragment -->针对高可伸缩、高可用网络服务的需求，给出了基于IP层和基于内容请求分发的负载平衡调度解决方法，它通过前端一个负载调度器（Load Balancer）无缝地将网络请求调度到真实服务器上，从而使得服务器集群的结构对客户是隐藏的， <!--StartFragment -->客户访问集群系统提供的网络服务就像访问一台高性能、高可用的服务器一样。因此整个网站的访问统计的取样就显得很简单，只要在一台 Web 服务器上分析自己的日志就行了，其他服务器的请求就是它的一个线性分布，系数大致就是硬件的性能比。</p><p>　　而现在整个网站由多个 Web 服务器 DNS 轮巡构成，网站结构对于用户是透明的，因此不能使用简单的抽样分析方法，分析日志的过程就比单个服务器的情况复杂得多。于是希望构建一套系统，能实现自动综合分析多个 Web 服务器的日志，给出准确直观的网站访问状况报告，而不是某台服务器单个的访问状况报告。</p><p>　　注：千万不能<!--StartFragment -->将日志记录到同一个远程(NFS)文件里。如果使用远程文件系统记录日志，带来的麻烦远比你获得的方便多的多！</p>
<br /><br />
<h3>Apache 日志分割、轮巡</h3><p>　　使用 <a href="http://www.cronolog.org/">cronolog</a>，到<a href="http://cronolog.org/download/cronolog-1.6.2.tar.gz">官方网站上下载 1.6.2 版</a>，编译：</p><div class="code">#tar -xzf cronolog-1.6.2.tar.gz<br />#cd cronolog-1.6.2<br />#./configure<br />#make<br /></div>Copy 到 Apache 的 bin 目录：<div class="code">#cp src/cronolog /usr/local/apache2/bin/cronolog</div>然后编辑 Apache 的 httpd.conf：<div class="code">#vi /usr/local/apache2/conf/httpd.conf</div>这里我自定义了一个 LogFormat &quot;all&quot;：<div class="code">Format &quot;%v %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; all</div><p>就是在 Apache 默认的 combined 格式的最前面加了 %v 以区别不同的虚拟主机访问。如果该 Web 服务器没有设置虚拟主机的话，%v 出来的将是星号(*)。查了 Apache 手册后，没找到能反映 <a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html">HTTP/1.1</a> 协议中 Host 字段所对应的变量。为了能和其他日志格式兼容，我用了个笨办法——直接将该服务器所对应的域名写在里面，于是，没有设置虚拟主机的 Appache 的日志格式成了类似：</p><div class="code">Format &quot;bbs.verycd.com %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; all</div>修改 CustomLog，实现按天分割、按周轮巡：<div class="code">CustomLog &quot;|/usr/local/apache2/bin/cronolog /var/log/httpd/%w.log&quot; all</div><p>重起 Apache，OK。</p><p>　　随后要做的是每天定时将前一天的 Log 发送到日志分析服务器，并删除五天前的那份 Log：</p><div class="code">#crontab -u root -e</div>每天凌晨 0:10 Copy 前一天的日志到日志分析服务器，我这就是 NFS 的路径；1:40删除旧日志：<div class="code">10 0 * * * /bin/cp -f /var/log/httpd/`date -d yesterday +\%w`.log /var/hosts/com/verycd/host1.log<br />10 1 * * * /bin/rm -f /var/log/httpd/`date --date &quot;5 days ago&quot; +\%w`.log</div><p /><p>　　到此，Apache 分割、轮巡，定时发送、删除日志的工作就做好了。</p><h3>合并日志</h3><p>　　现在日志分析服务器上已经有全部完整的、按日期精确分割的 Log 文件了，如何定时将它们合并在一起送交分析软件呢？在日志分析服务器上：</p><div class="code">#crontab -u root -e</div>每天 1:30 将host2.log、host3.log、host4.log、host5.log 按照时间排序合并到 all.log：<div class="code">30 1 * * *    /bin/sort -m -t : -k 2,4 -o /var/hosts/com/verycd/all.log   /var/hosts/com/verycd/host2.log  /var/hosts/com/verycd/host3.log   /var/hosts/com/verycd/host4.log   /var/hosts/com/verycd/host5.log</div><p /><p>　　完成日志合并工作。</p><h3>分析日志</h3><p>　　由于以前只接触过 Windows 系列服务器，因此我已经习惯使用跨平台的 <a href="http://awstats.sourceforge.net/">AwStats</a> 分析日志，那还是继续使用吧。在官方网站上就有下载，有 tgz 包和 rpm 安装包，还有 For Win32 的 .exe 安装程序……安装我这就不多说了，只是需要 Perl &gt; 5.0。</p><p>　　使用也非常简便，只要按照他的设置修改几处地方即可，修改 awstats.model.conf：</p><ul><li>LogFile=&quot;/var/hosts/com/verycd/all.log&quot;</li><li>LogFormat= &quot;%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot&quot;</li><li>DirData=&quot;./data&quot; # 分析好的数据存放的路径，可以是系统的绝对路径，也可以是相对于 awstats.pl 的相对路径，需要手动建立，并赋予 0777 属性</li><li>其他参数默认即可，每个参数配置文件里都有详细解释，耐心的话一会儿就能都基本理解了。</li></ul><p>　　新建 awstats.lib.verycd.conf awstats.bbs.verycd.conf awstats.emule.org.cn.conf 等配置文件（awstats.自定义配置名称.conf），保存于 awstats.pl 相同目录下，内容大致如下：</p><div class="code">Include &quot;awstats.model.conf&quot; # 引入主配置文件，共享参数<br /># 各自配置<br />SiteDomain=&quot;lib.verycd.com&quot; # 主机名<br />HostAliases=&quot;www.verycd.com&quot; # 主机别名</div><p /><p>　　将 wwwroot 目录下所有文件复制到网站的某个目录，例如，/log。在 Apache 中开放 awstats.pl 所在目录的 ExecCGI 权限：</p><div class="code">AddHandler cgi-script .cgi .pl<br />&lt;Directory /var/hosts/com/verycd/lib/log&gt;<br />    Options +ExecCGI<br />&lt;/Directory&gt;</div><p>　　另外，如果访问是500错误的话，修改 awstats.pl 的权限试试看。</p><p>　　接下去是设置定时分析日志：</p><ol><li>新建一个脚本文件 uodate_sites_logs.sh，内容大致如下：<div class="code">/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=lib.verycd.com -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=blog.verycd.com -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=emule.org.cn -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=dl1.emule.org.cn -update=1<br />/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=bbs.verycd.com -update=1<br /></div></li><li><div class="code">#crontab -u root -e</div></li><li>每天 3:30 执行这个脚本<div class="code">30 3 * * * /bin/sh /var/local/bin/crontab/update_sites_logs.sh</div></li></ol><h3>Demo</h3><p>　　VeryCD 的访问统计可见 <a href="http://www.verycd.com/log/">http://www.verycd.com/log/</a></p><h3>参考文档：</h3><p /><hr /><p /><ul><li><a href="http://www.chedong.com/tech/rotate_merge_log.html">http://www.chedong.com/tech/rotate_merge_log.html</a></li><li><a href="http://cronolog.org/">http://cronolog.org/</a></li><li><a href="http://awstats.sourceforge.net/">http://awstats.sourceforge.net/</a></li></ul>

</div></div></article></main></div><script src="/_next/static/chunks/webpack-fe83f22eebcef24a.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n3:I[8154,[\"177\",\"static/chunks/app/layout-18d5088c99c4b723.js\"],\"ThemeProvider\"]\n4:I[5244,[],\"\"]\n5:I[8725,[\"39\",\"static/chunks/app/error-819170ca5010743f.js\"],\"default\"]\n6:I[3866,[],\"\"]\n8:I[6213,[],\"OutletBoundary\"]\nb:I[6213,[],\"ViewportBoundary\"]\nd:I[6213,[],\"MetadataBoundary\"]\nf:I[4835,[],\"\"]\n:HC[\"/\",\"\"]\n:HL[\"/_next/static/css/89fe303d45fc1d3c.css\",\"style\"]\n2:T879,"])</script><script>self.__next_f.push([1,"\n            // Simplified MathJax rendering handler\n            window.renderMathJax = function() {\n              if (typeof window.MathJax !== 'undefined' \u0026\u0026 window.MathJax.typesetPromise) {\n                window.MathJax.typesetPromise()\n                  .then(() =\u003e console.log('MathJax render complete'))\n                  .catch(err =\u003e console.error('MathJax render error:', err));\n              }\n            };\n\n            // Setup on page load\n            window.addEventListener('load', function() {\n              console.log('Page loaded, setting up MathJax');\n\n              // Initial render with retry\n              const checkAndRender = function() {\n                if (typeof window.MathJax !== 'undefined' \u0026\u0026 window.MathJax.typesetPromise) {\n                  console.log('MathJax loaded, rendering');\n                  setTimeout(window.renderMathJax, 500);\n\n                  // URL change detection\n                  let lastUrl = window.location.href;\n                  setInterval(() =\u003e {\n                    if (lastUrl !== window.location.href) {\n                      console.log('URL changed, re-rendering');\n                      lastUrl = window.location.href;\n                      setTimeout(window.renderMathJax, 500);\n                    }\n                  }, 500);\n\n                  // Content change detection\n                  if (typeof MutationObserver !== 'undefined') {\n                    const observer = new MutationObserver(mutations =\u003e {\n                      if (mutations.some(m =\u003e m.addedNodes.length \u003e 0)) {\n                        console.log('Content changed, re-rendering');\n                        setTimeout(window.renderMathJax, 500);\n                      }\n                    });\n\n                    observer.observe(document.body, {\n                      childList: true,\n                      subtree: true\n                    });\n                  }\n                } else {\n                  console.log('MathJax not loaded yet, retrying');\n                  setTimeout(checkAndRender, 500);\n                }\n              };\n\n              setTimeout(checkAndRender, 1000);\n            });\n          "])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"dx1xWa8yFVQvlzKNyhDP3\",\"p\":\"\",\"c\":[\"\",\"2004\",\"11\",\"16\",\"000144\"],\"i\":false,\"f\":[[[\"\",{\"children\":[[\"slug\",\"2004/11/16/000144\",\"c\"],{\"children\":[\"__PAGE__\",{}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/89fe303d45fc1d3c.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"zh-CN\",\"suppressHydrationWarning\":true,\"className\":\"__variable_c4692a antialiased\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"script\",null,{\"async\":true,\"src\":\"/theme-switcher.js\"}],[\"$\",\"script\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"\\n            (function() {\\n              try {\\n                // Store theme preference but don't apply it immediately\\n                const storedTheme = localStorage.getItem('theme-preference');\\n                const preferredTheme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');\\n\\n                // Set a data attribute instead of class to avoid hydration mismatch\\n                document.documentElement.dataset.theme = preferredTheme;\\n\\n                // Apply the theme class after hydration\\n                window.addEventListener('DOMContentLoaded', () =\u003e {\\n                  setTimeout(() =\u003e {\\n                    document.documentElement.classList.add(preferredTheme);\\n                  }, 0);\\n                });\\n              } catch (e) {}\\n            })();\\n          \"}}],[\"$\",\"script\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"\\n            window.MathJax = {\\n              tex: {\\n                inlineMath: [['$', '$'], ['\\\\\\\\(', '\\\\\\\\)']],\\n                displayMath: [['$$', '$$'], ['\\\\\\\\[', '\\\\\\\\]']],\\n                processEscapes: true,\\n                processEnvironments: true\\n              },\\n              svg: {\\n                fontCache: 'global',\\n                scale: 1.1  // 增大公式字体大小，默认为 1.0\\n              },\\n              startup: {\\n                ready: function() {\\n                  console.log('MathJax is ready');\\n                  MathJax.startup.defaultReady();\\n                }\\n              }\\n            };\\n          \"}}],[\"$\",\"script\",null,{\"id\":\"MathJax-script\",\"async\":true,\"src\":\"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js\"}],[\"$\",\"script\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$2\"}}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L3\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"storageKey\":\"theme-preference\",\"children\":[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$5\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"div\",null,{\"className\":\"min-h-screen flex items-center justify-center\",\"children\":[\"$\",\"div\",null,{\"className\":\"text-center\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-4xl font-bold mb-4\",\"children\":\"404 - Page Not Found\"}],[\"$\",\"p\",null,{\"className\":\"text-gray-600\",\"children\":\"The page you're looking for doesn't exist.\"}]]}]}],\"$undefined\",[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}]]}],{\"children\":[[\"slug\",\"2004/11/16/000144\",\"c\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L4\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L7\",\"$undefined\",null,[\"$\",\"$L8\",null,{\"children\":[\"$L9\",\"$La\",null]}]]}],{},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"pUqHb8dFoMXJWzTcxc-JH\",{\"children\":[[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],[\"$\",\"$Ld\",null,{\"children\":\"$Le\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$f\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"10:I[4223,[\"48\",\"static/chunks/app/%5B...slug%5D/page-fc406cbb95aa160c.js\"],\"Header\"]\n11:I[9605,[\"48\",\"static/chunks/app/%5B...slug%5D/page-fc406cbb95aa160c.js\"],\"PostContent\"]\n12:T2086,"])</script><script>self.__next_f.push([1,"\n\r\n\u003cp\u003e　　今天在 \u003ca href=\"http://www.verycd.com/\"\u003eVeryCD\u003c/a\u003e 服务器上设置了访问日志的轮巡、合并、分析。\u003c/p\u003e\u003ch3\u003eVeryCD 目前的网页服务器配置结构\u003c/h3\u003e\u003cul\u003e\u003cli\u003e1 台 \u003ca href=\"http://www.mysql.com/\"\u003eMySQL\u003c/a\u003e 数据库 + NFS 文件服务器，无域名指向，定义为 host1.verycd.com；\u003c/li\u003e\u003cli\u003e2 台静态页 + 资源搜索服务器，域名为 www.verycd.com 及 lib.verycd.com，DNS 轮巡，定义为 host2.verycd.com 及 host3.verycd.com，host3 上还有 emule.org.cn；\u003c/li\u003e\u003cli\u003e2 台论坛服务器，域名为 bbs.verycd.com 及 blog.verycd.com，DNS 轮巡，定义为 host4.verycd.com 及 host5.verycd.com；\u003c/li\u003e\u003cli\u003eOS 均为 \u003ca href=\"http://www.redhat.com/\"\u003eRedHad Linux 9\u003c/a\u003e，Web 服务器均为 \u003ca href=\"http://httpd.apache.org/\"\u003eApache 2.0.49\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch4\u003e构思\u003c/h4\u003e\u003cp\u003e　　上个月 VeryCD 使用的是\u003cstrong\u003e章文嵩\u003c/strong\u003e博士的 \u003ca href=\"http://linuxvirtualserver.org/\"\u003eLinux Virtual Server\u003c/a\u003e 软件，该系统\u003c!--StartFragment --\u003e针对高可伸缩、高可用网络服务的需求，给出了基于IP层和基于内容请求分发的负载平衡调度解决方法，它通过前端一个负载调度器（Load Balancer）无缝地将网络请求调度到真实服务器上，从而使得服务器集群的结构对客户是隐藏的， \u003c!--StartFragment --\u003e客户访问集群系统提供的网络服务就像访问一台高性能、高可用的服务器一样。因此整个网站的访问统计的取样就显得很简单，只要在一台 Web 服务器上分析自己的日志就行了，其他服务器的请求就是它的一个线性分布，系数大致就是硬件的性能比。\u003c/p\u003e\u003cp\u003e　　而现在整个网站由多个 Web 服务器 DNS 轮巡构成，网站结构对于用户是透明的，因此不能使用简单的抽样分析方法，分析日志的过程就比单个服务器的情况复杂得多。于是希望构建一套系统，能实现自动综合分析多个 Web 服务器的日志，给出准确直观的网站访问状况报告，而不是某台服务器单个的访问状况报告。\u003c/p\u003e\u003cp\u003e　　注：千万不能\u003c!--StartFragment --\u003e将日志记录到同一个远程(NFS)文件里。如果使用远程文件系统记录日志，带来的麻烦远比你获得的方便多的多！\u003c/p\u003e\r\n\u003cbr /\u003e\u003cbr /\u003e\r\n\u003ch3\u003eApache 日志分割、轮巡\u003c/h3\u003e\u003cp\u003e　　使用 \u003ca href=\"http://www.cronolog.org/\"\u003ecronolog\u003c/a\u003e，到\u003ca href=\"http://cronolog.org/download/cronolog-1.6.2.tar.gz\"\u003e官方网站上下载 1.6.2 版\u003c/a\u003e，编译：\u003c/p\u003e\u003cdiv class=\"code\"\u003e#tar -xzf cronolog-1.6.2.tar.gz\u003cbr /\u003e#cd cronolog-1.6.2\u003cbr /\u003e#./configure\u003cbr /\u003e#make\u003cbr /\u003e\u003c/div\u003eCopy 到 Apache 的 bin 目录：\u003cdiv class=\"code\"\u003e#cp src/cronolog /usr/local/apache2/bin/cronolog\u003c/div\u003e然后编辑 Apache 的 httpd.conf：\u003cdiv class=\"code\"\u003e#vi /usr/local/apache2/conf/httpd.conf\u003c/div\u003e这里我自定义了一个 LogFormat \u0026quot;all\u0026quot;：\u003cdiv class=\"code\"\u003eFormat \u0026quot;%v %h %l %u %t \\\u0026quot;%r\\\u0026quot; %\u0026gt;s %b \\\u0026quot;%{Referer}i\\\u0026quot; \\\u0026quot;%{User-Agent}i\\\u0026quot;\u0026quot; all\u003c/div\u003e\u003cp\u003e就是在 Apache 默认的 combined 格式的最前面加了 %v 以区别不同的虚拟主机访问。如果该 Web 服务器没有设置虚拟主机的话，%v 出来的将是星号(*)。查了 Apache 手册后，没找到能反映 \u003ca href=\"http://www.w3.org/Protocols/rfc2616/rfc2616.html\"\u003eHTTP/1.1\u003c/a\u003e 协议中 Host 字段所对应的变量。为了能和其他日志格式兼容，我用了个笨办法——直接将该服务器所对应的域名写在里面，于是，没有设置虚拟主机的 Appache 的日志格式成了类似：\u003c/p\u003e\u003cdiv class=\"code\"\u003eFormat \u0026quot;bbs.verycd.com %h %l %u %t \\\u0026quot;%r\\\u0026quot; %\u0026gt;s %b \\\u0026quot;%{Referer}i\\\u0026quot; \\\u0026quot;%{User-Agent}i\\\u0026quot;\u0026quot; all\u003c/div\u003e修改 CustomLog，实现按天分割、按周轮巡：\u003cdiv class=\"code\"\u003eCustomLog \u0026quot;|/usr/local/apache2/bin/cronolog /var/log/httpd/%w.log\u0026quot; all\u003c/div\u003e\u003cp\u003e重起 Apache，OK。\u003c/p\u003e\u003cp\u003e　　随后要做的是每天定时将前一天的 Log 发送到日志分析服务器，并删除五天前的那份 Log：\u003c/p\u003e\u003cdiv class=\"code\"\u003e#crontab -u root -e\u003c/div\u003e每天凌晨 0:10 Copy 前一天的日志到日志分析服务器，我这就是 NFS 的路径；1:40删除旧日志：\u003cdiv class=\"code\"\u003e10 0 * * * /bin/cp -f /var/log/httpd/`date -d yesterday +\\%w`.log /var/hosts/com/verycd/host1.log\u003cbr /\u003e10 1 * * * /bin/rm -f /var/log/httpd/`date --date \u0026quot;5 days ago\u0026quot; +\\%w`.log\u003c/div\u003e\u003cp /\u003e\u003cp\u003e　　到此，Apache 分割、轮巡，定时发送、删除日志的工作就做好了。\u003c/p\u003e\u003ch3\u003e合并日志\u003c/h3\u003e\u003cp\u003e　　现在日志分析服务器上已经有全部完整的、按日期精确分割的 Log 文件了，如何定时将它们合并在一起送交分析软件呢？在日志分析服务器上：\u003c/p\u003e\u003cdiv class=\"code\"\u003e#crontab -u root -e\u003c/div\u003e每天 1:30 将host2.log、host3.log、host4.log、host5.log 按照时间排序合并到 all.log：\u003cdiv class=\"code\"\u003e30 1 * * *    /bin/sort -m -t : -k 2,4 -o /var/hosts/com/verycd/all.log   /var/hosts/com/verycd/host2.log  /var/hosts/com/verycd/host3.log   /var/hosts/com/verycd/host4.log   /var/hosts/com/verycd/host5.log\u003c/div\u003e\u003cp /\u003e\u003cp\u003e　　完成日志合并工作。\u003c/p\u003e\u003ch3\u003e分析日志\u003c/h3\u003e\u003cp\u003e　　由于以前只接触过 Windows 系列服务器，因此我已经习惯使用跨平台的 \u003ca href=\"http://awstats.sourceforge.net/\"\u003eAwStats\u003c/a\u003e 分析日志，那还是继续使用吧。在官方网站上就有下载，有 tgz 包和 rpm 安装包，还有 For Win32 的 .exe 安装程序……安装我这就不多说了，只是需要 Perl \u0026gt; 5.0。\u003c/p\u003e\u003cp\u003e　　使用也非常简便，只要按照他的设置修改几处地方即可，修改 awstats.model.conf：\u003c/p\u003e\u003cul\u003e\u003cli\u003eLogFile=\u0026quot;/var/hosts/com/verycd/all.log\u0026quot;\u003c/li\u003e\u003cli\u003eLogFormat= \u0026quot;%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot\u0026quot;\u003c/li\u003e\u003cli\u003eDirData=\u0026quot;./data\u0026quot; # 分析好的数据存放的路径，可以是系统的绝对路径，也可以是相对于 awstats.pl 的相对路径，需要手动建立，并赋予 0777 属性\u003c/li\u003e\u003cli\u003e其他参数默认即可，每个参数配置文件里都有详细解释，耐心的话一会儿就能都基本理解了。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e　　新建 awstats.lib.verycd.conf awstats.bbs.verycd.conf awstats.emule.org.cn.conf 等配置文件（awstats.自定义配置名称.conf），保存于 awstats.pl 相同目录下，内容大致如下：\u003c/p\u003e\u003cdiv class=\"code\"\u003eInclude \u0026quot;awstats.model.conf\u0026quot; # 引入主配置文件，共享参数\u003cbr /\u003e# 各自配置\u003cbr /\u003eSiteDomain=\u0026quot;lib.verycd.com\u0026quot; # 主机名\u003cbr /\u003eHostAliases=\u0026quot;www.verycd.com\u0026quot; # 主机别名\u003c/div\u003e\u003cp /\u003e\u003cp\u003e　　将 wwwroot 目录下所有文件复制到网站的某个目录，例如，/log。在 Apache 中开放 awstats.pl 所在目录的 ExecCGI 权限：\u003c/p\u003e\u003cdiv class=\"code\"\u003eAddHandler cgi-script .cgi .pl\u003cbr /\u003e\u0026lt;Directory /var/hosts/com/verycd/lib/log\u0026gt;\u003cbr /\u003e    Options +ExecCGI\u003cbr /\u003e\u0026lt;/Directory\u0026gt;\u003c/div\u003e\u003cp\u003e　　另外，如果访问是500错误的话，修改 awstats.pl 的权限试试看。\u003c/p\u003e\u003cp\u003e　　接下去是设置定时分析日志：\u003c/p\u003e\u003col\u003e\u003cli\u003e新建一个脚本文件 uodate_sites_logs.sh，内容大致如下：\u003cdiv class=\"code\"\u003e/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=lib.verycd.com -update=1\u003cbr /\u003e/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=blog.verycd.com -update=1\u003cbr /\u003e/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=emule.org.cn -update=1\u003cbr /\u003e/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=dl1.emule.org.cn -update=1\u003cbr /\u003e/usr/bin/perl /var/hosts/com/verycd/lib/log/awstats.pl -config=bbs.verycd.com -update=1\u003cbr /\u003e\u003c/div\u003e\u003c/li\u003e\u003cli\u003e\u003cdiv class=\"code\"\u003e#crontab -u root -e\u003c/div\u003e\u003c/li\u003e\u003cli\u003e每天 3:30 执行这个脚本\u003cdiv class=\"code\"\u003e30 3 * * * /bin/sh /var/local/bin/crontab/update_sites_logs.sh\u003c/div\u003e\u003c/li\u003e\u003c/ol\u003e\u003ch3\u003eDemo\u003c/h3\u003e\u003cp\u003e　　VeryCD 的访问统计可见 \u003ca href=\"http://www.verycd.com/log/\"\u003ehttp://www.verycd.com/log/\u003c/a\u003e\u003c/p\u003e\u003ch3\u003e参考文档：\u003c/h3\u003e\u003cp /\u003e\u003chr /\u003e\u003cp /\u003e\u003cul\u003e\u003cli\u003e\u003ca href=\"http://www.chedong.com/tech/rotate_merge_log.html\"\u003ehttp://www.chedong.com/tech/rotate_merge_log.html\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"http://cronolog.org/\"\u003ehttp://cronolog.org/\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"http://awstats.sourceforge.net/\"\u003ehttp://awstats.sourceforge.net/\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\r\n\n"])</script><script>self.__next_f.push([1,"7:[\"$\",\"div\",null,{\"className\":\"min-h-screen\",\"children\":[[\"$\",\"$L10\",null,{}],[\"$\",\"main\",null,{\"className\":\"container max-w-3xl mx-auto pb-24\",\"children\":[\"$\",\"article\",null,{\"className\":\"prose px-4 md:px-8 dark:prose-invert max-w-none\",\"children\":[[\"$\",\"h1\",null,{\"children\":\"Apache日志轮巡/合并/分析\"}],[\"$\",\"time\",null,{\"className\":\"text-muted-foreground\",\"children\":\"November 16, 2004\"}],[\"$\",\"$L11\",null,{\"html\":\"$12\"}]]}]}]]}]\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n9:null\n"])</script><script>self.__next_f.push([1,"a:null\ne:[[\"$\",\"title\",\"0\",{\"children\":\"Apache日志轮巡/合并/分析 - xdanger's Blog\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Apache日志轮巡/合并/分析\"}],[\"$\",\"link\",\"2\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}]]\n"])</script></body></html>